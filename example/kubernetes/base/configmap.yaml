apiVersion: v1
kind: ConfigMap
metadata:
  name: spring-actor-config
  namespace: spring-actor
  labels:
    app: spring-actor
data:
  application.yaml: |
    spring:
      application:
        name: spring-actor-app
      actor:
        pekko:
          name: spring-actor-system
          actor:
            provider: cluster
            allow-java-serialization: off
            warn-about-java-serializer-usage: on
            serializers:
              jackson-json: org.apache.pekko.serialization.jackson.JacksonJsonSerializer
            serialization-bindings:
              "io.github.seonwkim.core.serialization.JsonSerializable": jackson-json

          remote:
            artery:
              canonical:
                hostname: ${POD_IP}
                port: 2551
              bind:
                hostname: 0.0.0.0
                port: 2551

          cluster:
            downing-provider-class: org.apache.pekko.cluster.sbr.SplitBrainResolverProvider
            split-brain-resolver:
              active-strategy: keep-majority
              stable-after: 20s
              down-all-when-unstable: on

            shutdown-after-unsuccessful-join-seed-nodes: 60s

            coordinated-shutdown:
              phases:
                cluster-leave:
                  timeout: 10s
                cluster-sharding-shutdown-region:
                  timeout: 10s
                actor-system-terminate:
                  timeout: 10s

          management:
            http:
              hostname: ${POD_IP}
              port: 8558
              bind-hostname: 0.0.0.0
              bind-port: 8558

          discovery:
            method: kubernetes-api
            kubernetes-api:
              pod-namespace: ${NAMESPACE}
              pod-label-selector: app=spring-actor
              pod-port-name: management

          cluster:
            bootstrap:
              contact-point-discovery:
                discovery-method: kubernetes-api
                service-name: spring-actor
                required-contact-point-nr: 2
                stable-margin: 5s
                interval: 1s
                exponential-backoff-random-factor: 0.1
                exponential-backoff-max: 15s
                contact-with-all-contact-points: true

    server:
      port: 8080
      shutdown: graceful

    management:
      endpoints:
        web:
          exposure:
            include: health,prometheus,info,metrics
      endpoint:
        health:
          probes:
            enabled: true
          show-details: always
      health:
        readinessState:
          enabled: true
        livenessState:
          enabled: true
      metrics:
        export:
          prometheus:
            enabled: true
        tags:
          application: spring-actor-app
          environment: ${ENVIRONMENT:production}

    logging:
      level:
        root: INFO
        org.apache.pekko: INFO
        org.apache.pekko.cluster: INFO
        org.apache.pekko.management: DEBUG
        io.github.seonwkim: DEBUG
      pattern:
        console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
